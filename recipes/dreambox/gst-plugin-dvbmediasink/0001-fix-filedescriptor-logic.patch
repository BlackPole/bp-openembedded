From 07d0465fb3557aed499f51a767ca3d7714252cdc Mon Sep 17 00:00:00 2001
From: pieterg <pieterg@gmx.com>
Date: Sun, 12 Feb 2012 19:25:14 +0100
Subject: [PATCH] fix filedescriptor logic

avoid leaking filedescriptors or closing bad filedescriptors
---
 src/gstdvbaudiosink.c |   35 ++++++++++++++++++++---------------
 src/gstdvbvideosink.c |    3 ++-
 2 files changed, 22 insertions(+), 16 deletions(-)

diff --git a/src/gstdvbaudiosink.c b/src/gstdvbaudiosink.c
index fbe6f76..5ce0ceb 100644
--- a/src/gstdvbaudiosink.c
+++ b/src/gstdvbaudiosink.c
@@ -200,7 +200,7 @@ gst_dvbaudiosink_base_init (gpointer klass)
 	GstElementClass *element_class = GST_ELEMENT_CLASS (klass);
 
 	int fd = open("/proc/stb/info/model", O_RDONLY);
-	if ( fd > 0 )
+	if (fd >= 0)
 	{
 		gchar string[9] = { 0, };
 		ssize_t rd = read(fd, string, 8);
@@ -361,7 +361,7 @@ gst_dvbaudiosink_dispose (GObject * object)
 static gboolean
 gst_dvbaudiosink_set_location (GstDVBAudioSink * sink, const gchar * location)
 {
-	if (sink->dump_fd)
+	if (sink->dump_fd >= 0)
 		goto was_open;
 
 	g_free (sink->dump_filename);
@@ -713,16 +713,18 @@ gst_dvbaudiosink_event (GstBaseSink * sink, GstEvent * event)
 		GST_DEBUG_OBJECT (self, "GST_EVENT_NEWSEGMENT rate=%f applied_rate=%f\n", rate, applied_rate);
 
 		int video_fd = open("/dev/dvb/adapter0/video0", O_RDWR);
-		if (fmt == GST_FORMAT_TIME) {
-			if ( rate > 1 )
-				skip = (int) rate;
-			else if ( rate < 1 )
-				repeat = 1.0/rate;
-			ret = ioctl(video_fd, VIDEO_SLOWMOTION, repeat);
-			ret = ioctl(video_fd, VIDEO_FAST_FORWARD, skip);
+		if (video_fd >= 0) {
+			if (fmt == GST_FORMAT_TIME) {
+				if ( rate > 1 )
+					skip = (int) rate;
+				else if ( rate < 1 )
+					repeat = 1.0/rate;
+				ret = ioctl(video_fd, VIDEO_SLOWMOTION, repeat);
+				ret = ioctl(video_fd, VIDEO_FAST_FORWARD, skip);
 //			gst_segment_set_newsegment_full (&dec->segment, update, rate, applied_rate, dformat, cur, stop, time);
+			}
+			close(video_fd);
 		}
-		close(video_fd);
 		break;
 	}
 
@@ -792,7 +794,7 @@ loop_start:
 			GST_OBJECT_LOCK(self);
 			if (queue_front(&self->queue, &queue_data, &queue_entry_size)) {
 				int wr = write(self->fd, queue_data, queue_entry_size);
-				if ( self->dump_fd > 0 )
+				if (self->dump_fd >= 0)
 						write(self->dump_fd, queue_data, queue_entry_size);
 				if (wr < 0) {
 					switch (errno) {
@@ -817,7 +819,7 @@ loop_start:
 			}
 			GST_OBJECT_UNLOCK(self);
 			int wr = write(self->fd, data+written, len - written);
-			if ( self->dump_fd > 0 )
+			if (self->dump_fd >= 0)
 					write(self->dump_fd, data+written, len - written);
 			if (wr < 0) {
 				switch (errno) {
@@ -1024,16 +1026,19 @@ gst_dvbaudiosink_stop (GstBaseSink * basesink)
 		ioctl(self->fd, AUDIO_STOP);
 		ioctl(self->fd, AUDIO_SELECT_SOURCE, AUDIO_SOURCE_DEMUX);
 
-		if ( video_fd > 0 ) {
+		if (video_fd >= 0) {
 			ioctl(video_fd, VIDEO_SLOWMOTION, 0);
 			ioctl(video_fd, VIDEO_FAST_FORWARD, 0);
 			close (video_fd);
 		}
 		close(self->fd);
+		self->fd = -1;
 	}
 
-	if (self->dump_fd > 0)
+	if (self->dump_fd >= 0) {
 		close(self->dump_fd);
+		self->dump_fd = -1;
+	}
 
 	while(self->queue)
 		queue_pop(&self->queue);
@@ -1067,7 +1072,7 @@ gst_dvbaudiosink_change_state (GstElement * element, GstStateChange transition)
 
 		self->fd = open("/dev/dvb/adapter0/audio0", O_RDWR|O_NONBLOCK);
 
-		if (self->fd) {
+		if (self->fd >= 0) {
 			ioctl(self->fd, AUDIO_SELECT_SOURCE, AUDIO_SOURCE_MEMORY);
 			ioctl(self->fd, AUDIO_PLAY);
 			ioctl(self->fd, AUDIO_PAUSE);
diff --git a/src/gstdvbvideosink.c b/src/gstdvbvideosink.c
index a24764f..8aa7ca1 100644
--- a/src/gstdvbvideosink.c
+++ b/src/gstdvbvideosink.c
@@ -289,7 +289,7 @@ gst_dvbvideosink_base_init (gpointer klass)
 	GstElementClass *element_class = GST_ELEMENT_CLASS (klass);
 
 	int fd = open("/proc/stb/info/model", O_RDONLY);
-	if ( fd > 0 )
+	if (fd >= 0)
 	{
 		gchar string[9] = { 0, };
 		ssize_t rd = read(fd, string, 8);
@@ -1550,6 +1550,7 @@ gst_dvbvideosink_stop (GstBaseSink * basesink)
 		ioctl(self->fd, VIDEO_FAST_FORWARD, 0);
 		ioctl(self->fd, VIDEO_SELECT_SOURCE, VIDEO_SOURCE_DEMUX);
 		close(self->fd);
+		self->fd = -1;
 	}
 
 	if (self->codec_data)
-- 
1.7.5.4

