#@TYPE: Machine
#@NAME: Vu+ Duo
#@DESCRIPTION: Machine configuration for the Vu+ Duo

TARGET_ARCH = "mipsel"

#JAVA_mipsel = ",java"

MACHINE_ESSENTIAL_EXTRA_RDEPENDS += "kernel vuplus-dvb-modules \
    kernel-module-cifs  kernel-module-exportfs  kernel-module-isofs \
    kernel-module-reiserfs  \
    kernel-module-sr-mod    kernel-module-usb-storage \
    kernel-module-cdrom \
    kernel-module-snd-pcm kernel-module-snd \
    kernel-module-libata kernel-module-ntfs kernel-module-sata-svw \
    kernel-module-nls-base kernel-module-nls-iso8859-1 kernel-module-nls-cp437 \
	kernel-module-nls-utf8 \
    kernel-module-i2c-core kernel-module-firmware-class kernel-module-input kernel-module-evdev \
    kernel-module-msdos kernel-module-vfat kernel-module-fat \
    kernel-module-xfs"

#TARGET_FPU = "soft"
TARGET_FPU = "hard"

# used by sysvinit_2
#SERIAL_CONSOLE = "115200 ttyS0"

PREFERRED_VERSION_eglibc             = "2.11"
PREFERRED_VERSION_eglibc-initial     = "2.11"
MACHINE_FEATURES += "kernel26"

TARGET_CC_ARCH = "-march=mips32"

MACHINE_FEATURES += "alsa pci"

MACHINE_KERNEL_PR = "r6"

PREFERRED_VERSION_linux-${MACHINE} = "2.6.18-7.3"
PREFERRED_VERSION_linux-libc-headers = "2.6.18"

PREFERRED_GCC_VERSION ?= "4.4.4"
OLDEST_KERNEL = "2.6.18"

TARGET_ARCH = "mipsel"

GLIBC_EXTRA_OECONF = "--with-tls"

PREFERRED_PROVIDER_virtual/kernel = "linux-${MACHINE}"

DISTRO_FEATURES += " mplt"


PREFERRED_PROVIDER_task-vuplus-dvbapi = "task-vuplus-dvbapi3"
#PREFERRED_PROVIDER_task-vuplus-ui = "task-vuplus-enigma2"


#GLIBC_ADDONS = "nptl" which will be set at glibc_xxx.bb. Setting here causes a configure error.
GLIBC_ADDONS ?= "ports,nptl,libidn"
GLIBC_EXTRA_OECONF = "--disable-profile --with-tls --with-fp --with-__thread"

PREFERRED_PROVIDER_xserver = "xserver-kdrive"

EXTRA_IMAGEDEPENDS += "vuplus-makenfi-native"

MACHINE_FEATURES += "alsa pci"




EXTRA_IMAGECMD_jffs2 = " --eraseblock=0x20000 -n -l "
IMAGE_CMD_jffs2 = " \
    cp ${IMAGE_ROOTFS}/boot/vmlinux.gz ${DEPLOY_DIR_IMAGE}/${IMAGE_NAME}.vmlinux.gz; \
    rm -f ${IMAGE_ROOTFS}/boot/vmlinux.gz; \
    mkfs.jffs2 --root=${IMAGE_ROOTFS}/boot --faketime \
    --disable-compressor=lzo --compression-mode=size \
       --output=${DEPLOY_DIR_IMAGE}/${IMAGE_NAME}.boot.jffs2 \
       ${EXTRA_IMAGECMD}; rm -rf ${IMAGE_ROOTFS}/boot/*; \
       rm -rf ${IMAGE_ROOTFS}/tmp/*; \
       mkfs.jffs2 --root=${IMAGE_ROOTFS} \
    --disable-compressor=lzo --compression-mode=size \
       --output=${DEPLOY_DIR_IMAGE}/${IMAGE_NAME}.rootfs.jffs2 \
       ${EXTRA_IMAGECMD}; \
	   vfi3 ${DEPLOY_DIR_IMAGE}/${IMAGE_NAME}.rootfs.jffs2 ${DEPLOY_DIR_IMAGE}/${IMAGE_NAME}.boot.jffs2 ${DEPLOY_DIR_IMAGE}/${IMAGE_NAME}.vmlinux.gz > ${DEPLOY_DIR_IMAGE}/${IMAGE_NAME}.nfi; \
    mkdir -p ${DEPLOY_DIR_IMAGE}/vuplus/duo; \
    cp ${DEPLOY_DIR_IMAGE}/${IMAGE_NAME}.rootfs.jffs2 ${DEPLOY_DIR_IMAGE}/vuplus/duo/root_cfe_auto.jffs2; \
    cp ${DEPLOY_DIR_IMAGE}/${IMAGE_NAME}.vmlinux.gz ${DEPLOY_DIR_IMAGE}/vuplus/duo/kernel_cfe_auto.bin; \
    cp ${DEPLOY_DIR_IMAGE}/${IMAGE_NAME}.boot.jffs2 ${DEPLOY_DIR_IMAGE}/vuplus/duo/boot_cfe_auto.jffs2; \
    cd ${DEPLOY_DIR_IMAGE}; \
    rm -f usb_upgrade.zip; \
    zip duo_usb_upgrade.zip vuplus/duo/*; \
    rm -rf vuplus; \
"
 
#----------
#needed for wpa-supplicant
COMBINED_FEATURES_append = "${@base_contains('PREFERRED_VERSION_linux-${MACHINE}', '2.6.18', '', 'nl80211', d)}"


#take care when you do changes on MACHINE_ESSENTIAL_EXTRA_RDEPENDS/RRECOMMENDS you have to increment the recipes/tasks/task-boot.bb PR

module_autoload_nls-iso8859-1 = "nls-iso8859-1"
module_autoload_nls-iso8859-15 = "nls-iso8859-15"
module_autoload_nls-cp437 = "nls-cp437"
module_autoload_nls-cp850 = "nls-cp850"
module_autoload_nls-utf8 = "nls-utf8"

MACHINE_ESSENTIAL_EXTRA_RRECOMMENDS = "\
	kernel-module-cifs \
	kernel-module-exportfs \
	kernel-module-ext2 \
	kernel-module-xfs \
	kernel-module-iso9660 \
	kernel-module-udf \
	kernel-module-cdfs \
"

module_autoload_cifs = "cifs"
module_autoload_exportfs = "exportfs"
module_autoload_ext2 = "ext2"
module_autoload_xfs = "xfs"
module_autoload_iso9660 = "iso9660"
module_autoload_udf = "udf"
module_autoload_cdfs = "cdfs"
module_autoload_ntfs = "ntfs"


#KERNEL_EXTRA_CMD = "--disable-compressor=lzo "


MACHINE_FEATURES += "usbhost"

# openpli specific features:
MACHINE_FEATURES += "32bpp hdtv switchoff lpcm"

include conf/machine/include/autoload-usbserial.inc
